# オンデマンド vs プリエンプティブ VM

## 簡単に言うと

### オンデマンド VM
```
普通のレンタルサーバー
- 使いたい時に使える
- 勝手に止まらない
- 高い
```

### プリエンプティブ VM
```
激安だけど突然停止されるかもしれないサーバー
- 使いたい時に使える
- GCPの都合で勝手に止められる（24時間以内）
- めちゃくちゃ安い（80%オフ）
```

## 詳細比較表

| 項目 | オンデマンド VM | プリエンプティブ VM |
|------|----------------|-------------------|
| **料金** | 通常価格 | **70-80% 割引** |
| **例（n1-standard-2）** | $0.095/時間 | **$0.020/時間** |
| **稼働保証** | ✅ ずっと動く | ❌ 最大24時間で強制停止 |
| **停止のタイミング** | 自分で決める | GCPが決める（30秒前通知） |
| **自動再起動** | ✅ 設定可能 | ❌ 不可 |
| **Live Migration** | ✅ 可能 | ❌ 不可 |
| **SLA（稼働保証）** | ✅ あり | ❌ なし |
| **予約可能** | ✅ 可能 | ❌ 不可 |
| **用途** | 本番環境、長期運用 | テスト、バッチ、実験 |

## オンデマンド VM の特徴

### メリット

1. **安定性**
   - 勝手に止まらない
   - 自分が停止するまでずっと動く
   - 本番環境向け

2. **自動再起動**
   ```yaml
   GCP のメンテナンス時:
   - 自動的に別のホストに移行（Live Migration）
   - サービスが止まらない
   ```

3. **SLA（サービスレベル保証）**
   - 99.5% 以上の稼働保証
   - ダウンタイムがあれば返金

4. **長期運用向き**
   - Webサーバー
   - データベース
   - 常時稼働が必要なサービス

### デメリット

1. **高い**
   - プリエンプティブの 4-5 倍の料金

### 料金例（東京リージョン）

| マシンタイプ | 料金/時間 | 料金/月 |
|-------------|----------|---------|
| n1-standard-2 | $0.095 | $69.35 |
| n1-standard-4 | $0.190 | $138.70 |
| e2-standard-2 | $0.067 | $48.91 |

## プリエンプティブ VM の特徴

### メリット

1. **激安！**
   - 70-80% 割引
   - 同じスペックで 1/5 の料金

2. **性能は同じ**
   - オンデマンドと全く同じハードウェア
   - CPUもメモリもネットワークも同じ性能

3. **すぐに起動できる**
   - オンデマンドと同じように起動
   - 起動時間も同じ

### デメリット

1. **24時間以内に必ず停止される**
   ```
   最短: 30秒後
   最長: 24時間後
   平均: 数時間〜半日程度
   ```

2. **いつでも停止される可能性**
   - GCPのリソースが足りなくなったら即停止
   - 30秒前に警告が来るだけ
   - 保存していないデータは失われる

3. **自動再起動なし**
   - 停止されたら終わり
   - 自分で再起動する必要がある

4. **SLA なし**
   - 稼働保証なし
   - 止まっても文句は言えない

### 料金例（東京リージョン）

| マシンタイプ | 料金/時間 | 割引率 |
|-------------|----------|--------|
| n1-standard-2 | $0.020 | 79% オフ |
| n1-standard-4 | $0.040 | 79% オフ |
| e2-standard-2 | $0.020 | 70% オフ |

## 停止のメカニズム

### プリエンプティブ VM が停止される理由

1. **GCP のキャパシティ不足**
   ```
   他のユーザーがオンデマンドVMを大量に起動
   → リソースが足りなくなった
   → プリエンプティブVMを停止して空きを作る
   ```

2. **24時間経過**
   ```
   起動から24時間が経過
   → 自動的に停止される（必ず）
   ```

### 停止の流れ

```
1. GCP が停止を決定

2. 30秒前に警告（Shutdown Script実行可能）
   ↓
   インスタンス内で以下が実行される:
   - shutdown-script（設定している場合）
   - 保存処理などを実行できる

3. 30秒後に強制停止
   ↓
   - プロセスが強制終了（SIGTERM → SIGKILL）
   - 保存していないデータは消失

4. インスタンスは TERMINATED 状態
   ↓
   - 手動で再起動する必要がある
   - 自動では再起動されない
```

### シャットダウンスクリプトの例

```bash
#!/bin/bash
# /etc/shutdown-script.sh

echo "Preemptible VM is shutting down!"

# 実行中のベンチマークを停止
docker-compose down

# 結果を保存
tar -czf /tmp/results-$(date +%Y%m%d-%H%M%S).tar.gz /home/ubuntu/ipfs_bench/test-results/

# GCSにバックアップ（オプション）
gsutil cp /tmp/results-*.tar.gz gs://your-bucket/backups/

echo "Shutdown script completed"
```

設定方法:
```hcl
# Terraform
metadata = {
  shutdown-script = file("${path.module}/shutdown-script.sh")
}
```

## 使い分けガイド

### オンデマンド VM を使うべき場合

✅ **本番環境**
```
- Webサーバー
- データベース
- APIサーバー
- 常時稼働が必要なサービス
```

✅ **長期実験（24時間以上）**
```
- 数日〜数週間の実験
- 長時間の学習（機械学習など）
```

✅ **重要なデータ処理**
```
- 途中で止まると困る処理
- 再実行が難しい処理
```

### プリエンプティブ VM を使うべき場合

✅ **短期ベンチマーク（数時間〜半日）** ← 今回これ！
```
- IPFSのベンチマーク
- 性能測定
- 負荷テスト
```

✅ **バッチ処理**
```
- 夜間バッチ
- データ変換
- レポート生成
```

✅ **開発・テスト環境**
```
- 機能テスト
- 統合テスト
- デバッグ
```

✅ **並列処理（停止されても再実行できる）**
```
- 動画エンコーディング
- 画像処理
- データ分析
```

✅ **ステートレスなワークロード**
```
- 結果を随時保存できる処理
- 途中から再開できる処理
```

## IPFS ベンチマークでの推奨

### プリエンプティブ VM が最適な理由

1. **短期実験（8時間程度）**
   ```
   24時間以内に終わる
   → プリエンプティブで問題なし
   ```

2. **再実行可能**
   ```
   もし停止されても:
   - ベンチマークを再実行すればいい
   - 重要なデータが失われるわけではない
   ```

3. **コスト削減**
   ```
   $9.20 → $6.80（約 $2.40 = ¥360 削減）
   ```

4. **結果は随時保存**
   ```
   ベンチマーク結果は CSV に随時保存される
   → 停止されても主要なデータは残る
   ```

### リスク軽減策

#### 1. 定期的にバックアップ

```bash
#!/bin/bash
# backup.sh - cron で定期実行

# 結果を圧縮
tar -czf /tmp/results-$(date +%Y%m%d-%H%M%S).tar.gz ~/ipfs_bench/test-results/

# GCS にアップロード（オプション）
gsutil cp /tmp/results-*.tar.gz gs://your-backup-bucket/
```

#### 2. Shutdown Script で保存

```bash
# インスタンス停止時に自動実行されるスクリプト
# 30秒間で実行できる処理を書く
```

#### 3. 複数ノードで冗長化

```
4ノード構成:
- 1-2台が停止されても他が動いている
- 全部停止される確率は低い
```

#### 4. こまめに結果を確認

```bash
# ローカルに定期的にダウンロード
gcloud compute scp ipfs-bench-node-1:~/ipfs_bench/test-results/ ./results/ --zone=asia-northeast1-a --recurse
```

## 実際の停止頻度（参考）

### 経験則（非公式）

**リージョン・ゾーンによって異なる:**

| 時間帯 | 停止確率 | 理由 |
|--------|---------|------|
| **深夜（日本時間）** | 低い | 利用者が少ない |
| **日中（日本時間）** | 中程度 | 利用者が多い |
| **米国日中** | やや高い | グローバルで利用が集中 |

**平均的な稼働時間:**
- 数時間〜12時間程度は安定稼働することが多い
- 24時間が最大

**リスクの高い状況:**
- クリスマス、ブラックフライデー（需要増）
- 大規模障害後（リソース逼迫）
- 新サービス発表直後

## プリエンプティブ VM の豆知識

### 1. 複数ゾーンで分散すると安定

```hcl
# 異なるゾーンに配置
zone = ["asia-northeast1-a", "asia-northeast1-b", "asia-northeast1-c"]
```

理由: ゾーンごとに独立したリソースプール

### 2. AWS Spot Instance との違い

| 項目 | GCP Preemptible | AWS Spot |
|------|----------------|----------|
| 割引率 | 70-80% | 50-90% |
| 最大稼働時間 | 24時間 | 無制限 |
| 価格変動 | なし（固定） | あり（需要で変動） |
| 停止予告 | 30秒 | 2分 |

### 3. Spot VM との違い（GCPの新しいタイプ）

**Spot VM（2021年〜）:**
- プリエンプティブの後継
- 24時間制限なし
- 価格は同じ
- より柔軟な停止ポリシー

**現状:**
- プリエンプティブでも十分
- Spot VM はまだベータ版の機能が多い

## コスト比較（具体例）

### 8時間ベンチマーク、4ノード（n1-standard-2）

| コスト項目 | オンデマンド | プリエンプティブ | 差額 |
|-----------|------------|----------------|------|
| インスタンス | $3.04 | $0.64 | **-$2.40** |
| ディスク | $0.16 | $0.16 | $0.00 |
| ネットワーク | $6.00 | $6.00 | $0.00 |
| **合計** | **$9.20** | **$6.80** | **-$2.40** |
| **円換算** | **¥1,380** | **¥1,020** | **-¥360** |

**削減率: 26%**

### 24時間実験、4ノード

| コスト項目 | オンデマンド | プリエンプティブ | 差額 |
|-----------|------------|----------------|------|
| インスタンス | $9.12 | $1.92 | **-$7.20** |
| ディスク | $0.16 | $0.16 | $0.00 |
| ネットワーク | $18.00 | $18.00 | $0.00 |
| **合計** | **$27.28** | **$20.08** | **-$7.20** |
| **円換算** | **¥4,092** | **¥3,012** | **-¥1,080** |

**削減率: 26%**

注: プリエンプティブは24時間で必ず停止されるため、再起動が必要

## まとめ

### オンデマンド VM
```
メリット:
✅ 安定稼働（勝手に止まらない）
✅ 本番環境向け
✅ 長期運用可能

デメリット:
❌ 高い（通常価格）

用途:
- 本番環境
- 24時間以上の長期実験
- 重要な処理
```

### プリエンプティブ VM
```
メリット:
✅ 激安（70-80%オフ）
✅ 性能は同じ
✅ 短期実験に最適

デメリット:
❌ 24時間以内に停止される
❌ いつでも停止される可能性
❌ 自動再起動なし

用途:
- 短期ベンチマーク ← 今回これ！
- バッチ処理
- 開発・テスト
- 再実行可能な処理
```

### IPFS ベンチマークでの推奨

**プリエンプティブ VM を使うべき！**

理由:
1. 8時間程度の短期実験
2. 再実行可能
3. コスト削減（約 ¥360）
4. 停止リスクは低い（数時間なら）

```hcl
# terraform.tfvars
use_preemptible = true
```

**これで約 ¥1,000 で実験できます！**
