# グローバルIPFSベンチマーク: クラウド vs ローカル

## 結論: クラウド（AWS/GCP）を推奨

グローバルIPFSネットワークのベンチマークには、**AWS/GCPなどのクラウドプラットフォームを使用する方が圧倒的に有利**です。

## クラウド（AWS/GCP）のメリット

### 1. ネットワーク環境

**AWS/GCP:**
- グローバルIPv4アドレスを簡単に取得
- ファイアウォール設定が柔軟（Security Groups/Firewall Rules）
- NAT traversalの問題がない
- 実際のインターネット環境に近い条件でテスト可能
- 複数リージョンでのテストが容易

**Mac（ローカル）:**
- ホームルーターのNAT越えが必要
- ISPによる制限（ポート制限、帯域制限）
- 動的IPアドレスの問題
- ファイアウォール設定が複雑
- 実際のグローバルネットワークへの接続が不安定

### 2. スケーラビリティ

**AWS/GCP:**
- 複数のインスタンスを簡単に起動
- 異なるリージョンにノードを配置可能（東京、シンガポール、米国など）
- オートスケーリング対応
- 一時的に大量のリソースを使用可能

**Mac（ローカル）:**
- 単一マシンに制限される
- リソース（CPU、メモリ、ネットワーク）に限界
- 複数リージョンのシミュレーションが困難

### 3. 再現性と制御

**AWS/GCP:**
- Infrastructure as Code（Terraform、CloudFormation）で環境を再現可能
- スナップショット、AMI/イメージで環境を保存
- ネットワーク帯域幅を詳細に制御可能
- 計測ツールが豊富（CloudWatch、Stackdriver）

**Mac（ローカル）:**
- 環境の再現が困難
- ローカルマシンの状態に依存
- バックグラウンドプロセスの影響を受けやすい

### 4. コスト効率

**AWS/GCP:**
- 使用した分だけ課金（従量課金）
- スポットインスタンス/プリエンプティブVMで大幅にコスト削減
- 必要な時だけ起動、終了後は課金なし
- 例: EC2 t3.medium（2vCPU、4GB）で $0.0416/時間（スポット: ~$0.012/時間）

**Mac（ローカル）:**
- 電気代
- マシンの占有時間
- 長時間実行すると非効率

### 5. セキュリティとネットワーク分離

**AWS/GCP:**
- VPC/VNetで完全に分離されたネットワーク環境
- セキュリティグループで細かくアクセス制御
- 本番環境への影響なし

**Mac（ローカル）:**
- ホームネットワークを使用
- 他のデバイスへの影響の可能性
- セキュリティリスク（グローバルIPFSへの接続）

## 推奨アーキテクチャ

### パターン1: 単一リージョン・複数ノード

```
AWS/GCP 単一リージョン (例: ap-northeast-1/asia-northeast1)
├── IPFS Node 1 (Uploader)
├── IPFS Node 2 (Downloader)
├── IPFS Node 3 (Downloader)
└── IPFS Node 4 (Relay/Bootstrap)
```

**用途:**
- 基本的な性能測定
- 同一リージョン内での並行アクセステスト
- コストを抑えたい場合

### パターン2: マルチリージョン・グローバル分散

```
複数リージョン
├── Asia (Tokyo)
│   ├── IPFS Node 1 (Uploader)
│   └── IPFS Node 2
├── Asia (Singapore)
│   └── IPFS Node 3 (Downloader)
├── US (N. Virginia)
│   └── IPFS Node 4 (Downloader)
└── Europe (Frankfurt)
    └── IPFS Node 5 (Downloader)
```

**用途:**
- グローバル分散環境でのレイテンシ測定
- 地域間のデータ転送速度測定
- 実際のCDN的な使用ケースのシミュレーション

### パターン3: ハイブリッド（クラウド + Mac）

```
AWS/GCP (複数ノード) ←→ Mac (監視・制御ノード)
```

**用途:**
- Macから複数のクラウドノードを制御
- Macで結果の収集・分析
- 開発・デバッグはMac、本番ベンチマークはクラウド

## 実装の容易さ

### Docker環境の移行

既存のDocker環境はそのままクラウドで使用可能:

```bash
# EC2/GCE インスタンスで
git clone <your-repo>
cd ipfs_bench
docker-compose up -d
./run_bench_10nodes.sh
```

### Terraform での自動化例

```hcl
# main.tf
resource "aws_instance" "ipfs_node" {
  count         = 4
  ami           = "ami-xxxxxxxxx"  # Ubuntu/Amazon Linux
  instance_type = "t3.medium"

  user_data = <<-EOF
    #!/bin/bash
    # Docker インストール
    curl -fsSL https://get.docker.com | sh
    # リポジトリクローン
    git clone <your-repo>
    cd ipfs_bench
    docker-compose up -d
  EOF

  tags = {
    Name = "ipfs-bench-node-${count.index}"
  }
}
```

## コスト見積もり

### AWS EC2 の例（東京リージョン）

**オンデマンド:**
- t3.medium (2vCPU, 4GB): $0.0416/時間 × 4ノード = $0.1664/時間
- 8時間のベンチマーク: ~$1.33

**スポットインスタンス:**
- t3.medium スポット: ~$0.012/時間 × 4ノード = $0.048/時間
- 8時間のベンチマーク: ~$0.38

**ストレージ（EBS）:**
- gp3 30GB × 4: ~$3.20/月（使用日数で按分）

**ネットワーク:**
- データ転送（アウト）: 最初の100GBは $0.114/GB
- ベンチマークで50GB転送: ~$5.70

**合計（8時間のテスト）:**
- オンデマンド: ~$10
- スポット: ~$7

### GCP Compute Engine の例（東京リージョン）

**オンデマンド:**
- n1-standard-2 (2vCPU, 7.5GB): $0.095/時間 × 4ノード = $0.38/時間
- 8時間のベンチマーク: ~$3.04

**プリエンプティブVM:**
- n1-standard-2 プリエンプティブ: ~$0.02/時間 × 4ノード = $0.08/時間
- 8時間のベンチマーク: ~$0.64

**ストレージ（Persistent Disk）:**
- Standard 30GB × 4: ~$1.60/月

**ネットワーク:**
- Egress（アウト）: ~$0.12/GB
- ベンチマークで50GB転送: ~$6.00

**合計（8時間のテスト）:**
- オンデマンド: ~$10
- プリエンプティブ: ~$8

## Mac でやるべきこと

Macは以下の用途に最適:

1. **開発・デバッグ**
   - Dockerコンテナのローカルテスト
   - スクリプトの開発
   - 小規模なテスト実行

2. **制御・監視**
   - クラウドノードの起動/停止
   - ベンチマーク実行の制御
   - 結果の収集とダウンロード

3. **分析・可視化**
   - `analyze_results.py` の実行
   - `visualize_results.py` での可視化
   - レポート作成

4. **ローカルIPFSとの比較用ベースライン**
   - 理想的な環境（低レイテンシ）での性能測定
   - クラウド結果との比較対象

## 次のステップ

### ステップ1: クラウドプラットフォームの選択

- [ ] AWS or GCP?
- [ ] リージョンの選択（単一 or 複数）
- [ ] インスタンスタイプの決定

### ステップ2: 環境構築

- [ ] IaC（Terraform/CloudFormation）でのセットアップ
- [ ] 既存のDockerベンチマーク環境の移植
- [ ] ネットワーク設定（VPC、Security Groups）

### ステップ3: ベンチマーク実行

- [ ] グローバルIPFSネットワークへの接続
- [ ] 性能測定の実行
- [ ] 結果の収集

### ステップ4: 分析

- [ ] Macで結果を分析・可視化
- [ ] ローカル環境との比較
- [ ] レポート作成

## 質問と決定事項

1. **予算はどのくらいですか？**
   - $10-20 程度で十分なテストが可能

2. **どのクラウドプラットフォームを使いますか？**
   - AWS: より広く使われている、リソースが豊富
   - GCP: シンプル、Kubernetesとの統合が良い

3. **テスト期間はどのくらいですか？**
   - 短期集中（数時間）: スポット/プリエンプティブで低コスト
   - 長期継続（数日〜週）: コスト計算が重要

4. **グローバル分散が必要ですか？**
   - 単一リージョンで十分か？
   - 複数リージョン間のレイテンシを測定したいか？

5. **既存の環境を活用しますか？**
   - 既にDocker環境があるので、そのまま移行可能
   - main.goのベンチマークロジックも再利用可能
