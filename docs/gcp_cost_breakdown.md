# GCP IPFS ベンチマークのコスト詳細

## プロジェクト情報
- **プロジェクト名**: research
- **プロジェクト ID**: research-383706
- **リージョン**: asia-northeast1（東京）

## 静的 IP のコスト

### 静的 IP アドレスの料金（東京リージョン）

**使用中の静的 IP:**
- 料金: **無料**（インスタンスにアタッチされている場合）

**未使用の静的 IP:**
- 料金: **$0.010/時間 = $7.30/月**

**つまり:**
- ✅ インスタンスに割り当てて使用中 → **無料**
- ❌ 予約だけして使っていない → **課金される**

### 推奨設定

```hcl
# terraform.tfvars
use_static_ip = false  # エフェメラル IP で十分（無料）
```

**理由:**
- ベンチマーク用途なら動的 IP で十分
- 静的 IP は長期運用や DNS 登録が必要な場合のみ
- 削除し忘れると課金され続ける

## コスト詳細計算

### デフォルト設定（4ノード、8時間ベンチマーク）

#### マシンタイプ: n1-standard-2

**スペック:**
- vCPU: 2
- メモリ: 7.5 GB
- ネットワーク: 最大 10 Gbps

**料金（東京リージョン）:**

| 項目 | 単価 | 数量 | 時間 | 小計 |
|------|------|------|------|------|
| インスタンス（オンデマンド） | $0.095/時間 | 4台 | 8時間 | $3.04 |
| インスタンス（プリエンプティブ） | $0.020/時間 | 4台 | 8時間 | $0.64 |
| 永続ディスク（標準、30GB） | $0.040/GB/月 | 120GB | - | $0.16 |
| ネットワーク送信（アジア内） | $0.12/GB | 50GB | - | $6.00 |
| ネットワーク受信 | 無料 | - | - | $0.00 |
| 静的IP（使用中） | 無料 | - | - | $0.00 |
| 静的IP（未使用） | $0.010/時間 | 4個 | 8時間 | $0.32 |

**合計（オンデマンド）:**
```
インスタンス:     $3.04
ディスク:         $0.16
ネットワーク:     $6.00
静的IP（未使用）: $0.00  # use_static_ip = false の場合
─────────────────────────
合計:             $9.20  ≈ ¥1,380 (¥150/$)
```

**合計（プリエンプティブ VM）:**
```
インスタンス:     $0.64
ディスク:         $0.16
ネットワーク:     $6.00
─────────────────────────
合計:             $6.80  ≈ ¥1,020 (¥150/$)
```

### ネットワーク転送量の詳細

**無料枠:**
- インバウンド（受信）: 完全無料
- 同一ゾーン内の通信: 無料
- Google サービスへの通信: 無料

**課金対象:**
- インターネットへの送信（Egress）

**料金（東京リージョン→インターネット）:**
| 月間転送量 | 料金 |
|-----------|------|
| 0 - 1 TB | $0.12/GB |
| 1 - 10 TB | $0.11/GB |
| 10+ TB | $0.08/GB |

**ベンチマークでの想定:**
- IPFS ファイル送信: 40 GB
- メトリクス/ログ: 5 GB
- その他通信: 5 GB
- **合計: 約 50 GB → $6.00**

### 他のマシンタイプとの比較

#### n2-standard-2（新世代）

**スペック:**
- vCPU: 2
- メモリ: 8 GB

**料金:**
- オンデマンド: $0.098/時間
- プリエンプティブ: $0.024/時間

**8時間 × 4台:**
- オンデマンド: $3.14
- プリエンプティブ: $0.77

#### e2-standard-2（コスト最適化）

**スペック:**
- vCPU: 2
- メモリ: 8 GB

**料金:**
- オンデマンド: $0.067/時間
- プリエンプティブ: $0.020/時間

**8時間 × 4台:**
- オンデマンド: $2.14
- プリエンプティブ: $0.64

**推奨:** e2-standard-2 プリエンプティブが最もコストパフォーマンスが良い！

#### n1-standard-4（ハイスペック）

**スペック:**
- vCPU: 4
- メモリ: 15 GB

**料金:**
- オンデマンド: $0.190/時間
- プリエンプティブ: $0.040/時間

**8時間 × 4台:**
- オンデマンド: $6.08
- プリエンプティブ: $1.28

## シナリオ別コスト見積もり

### シナリオ 1: 短期ベンチマーク（8時間）

**設定:**
- ノード数: 4
- マシンタイプ: e2-standard-2
- プリエンプティブ: true
- 静的IP: false
- ネットワーク転送: 50 GB

**コスト:**
```
インスタンス:  $0.020 × 4 × 8 = $0.64
ディスク:      $0.16
ネットワーク:  $6.00
─────────────────────────────────
合計:          $6.80 ≈ ¥1,020
```

**推奨度: ⭐⭐⭐⭐⭐**

### シナリオ 2: 中期テスト（24時間）

**設定:**
- ノード数: 4
- マシンタイプ: n1-standard-2
- プリエンプティブ: true
- 静的IP: false
- ネットワーク転送: 150 GB

**コスト:**
```
インスタンス:  $0.020 × 4 × 24 = $1.92
ディスク:      $0.16
ネットワーク:  $18.00
─────────────────────────────────
合計:          $20.08 ≈ ¥3,012
```

### シナリオ 3: 長期実験（7日間、168時間）

**設定:**
- ノード数: 4
- マシンタイプ: n1-standard-2
- オンデマンド: true（プリエンプティブは24時間以内に停止）
- 静的IP: false
- ネットワーク転送: 500 GB

**コスト:**
```
インスタンス:  $0.095 × 4 × 168 = $63.84
ディスク:      $0.37
ネットワーク:  $60.00
─────────────────────────────────
合計:          $124.21 ≈ ¥18,632
```

**注意:** 7日間以上ならプリエンプティブは不向き

### シナリオ 4: 大規模ベンチマーク（8ノード、8時間）

**設定:**
- ノード数: 8
- マシンタイプ: e2-standard-2
- プリエンプティブ: true
- 静的IP: false
- ネットワーク転送: 100 GB

**コスト:**
```
インスタンス:  $0.020 × 8 × 8 = $1.28
ディスク:      $0.32
ネットワーク:  $12.00
─────────────────────────────────
合計:          $13.60 ≈ ¥2,040
```

## コスト最適化のヒント

### 1. プリエンプティブ VM を使う

**削減率: 約 70-80%**

```hcl
# terraform.tfvars
use_preemptible = true
```

**メリット:**
- コストが 1/5 程度
- 短期実験に最適

**デメリット:**
- 24時間以内に停止される可能性
- 長期実験には不向き

### 2. コスト最適化マシンタイプを選ぶ

```hcl
# terraform.tfvars
machine_type = "e2-standard-2"  # n1 より 30% 安い
```

### 3. 静的 IP を避ける

```hcl
# terraform.tfvars
use_static_ip = false  # エフェメラル IP で十分
```

**削減:** $0.32/8時間（4ノード）

### 4. ネットワーク転送量を抑える

**方法:**
- 結果ファイルを圧縮してから転送
- 不要なログを削除
- ローカルで分析後に小さいレポートだけ転送

**例:**
```bash
# VM 上で結果を圧縮
tar -czf results.tar.gz test-results/

# ローカルに転送（10GB → 2GB）
gcloud compute scp ipfs-bench-node-1:~/results.tar.gz . --zone=asia-northeast1-a
```

**削減:** 80% 圧縮なら $4.80/50GB

### 5. 使い終わったらすぐに削除

```bash
# 必ず実行！
terraform destroy
```

**削減:** 放置による無駄なコスト

### 6. ディスクサイズを最適化

```hcl
# terraform.tfvars
disk_size_gb = 20  # 30GB → 20GB（十分な場合）
disk_type = "pd-standard"  # pd-ssd は 4倍高い
```

**削減:** $0.05/月（4ノード）

### 7. ノード数を最小限に

```hcl
# terraform.tfvars
node_count = 2  # 最初は 2ノードでテスト
```

実験してから増やす戦略。

### 8. リージョンを見直す

| リージョン | 場所 | インスタンス料金 | ネットワーク料金 |
|-----------|------|----------------|----------------|
| asia-northeast1 | 東京 | $0.095/h | $0.12/GB |
| asia-northeast3 | 韓国 | $0.095/h | $0.12/GB |
| us-central1 | アイオワ | $0.0475/h | $0.12/GB |
| europe-west4 | オランダ | $0.0522/h | $0.12/GB |

**us-central1 なら半額！**（ただしレイテンシが増える）

## 推奨設定（コスト最適）

### 研究用（project: research-383706）

```hcl
# terraform.tfvars
project_id = "research-383706"

# 東京リージョン
region = "asia-northeast1"
zone   = "asia-northeast1-a"

# リソース
prefix = "ipfs-bench"
environment = "research"

# コスト最適化
node_count = 4
machine_type = "e2-standard-2"  # コスト最適
use_preemptible = true          # 80% コスト削減
use_static_ip = false           # 静的IP不要

# ディスク
disk_size_gb = 30
disk_type = "pd-standard"  # 標準ディスク

# セキュリティ
allowed_ip_ranges = ["0.0.0.0/0"]  # または自分のIPのみ
```

**8時間ベンチマーク想定コスト:**
```
インスタンス:  $0.64
ディスク:      $0.16
ネットワーク:  $6.00
─────────────────────
合計:          $6.80 ≈ ¥1,020
```

## コスト監視

### GCP コンソールで確認

1. **請求情報:**
   https://console.cloud.google.com/billing

2. **プロジェクト別コスト:**
   https://console.cloud.google.com/billing/projects/research-383706

3. **予算アラート設定:**
   ```
   Billing → Budgets & alerts → CREATE BUDGET
   ```

### terraform で見積もり

```bash
# プランでリソース数を確認
terraform plan

# 作成されるリソース:
# - google_compute_instance: 4台
# - google_compute_firewall: 1個
# - google_compute_address: 0個（use_static_ip = false の場合）
```

### gcloud で確認

```bash
# 現在のインスタンス一覧
gcloud compute instances list --project=research-383706

# コスト詳細（課金情報へのアクセス権限が必要）
gcloud billing accounts list
```

## まとめ

### 静的 IP について

- **使用中**: 無料
- **未使用**: $0.010/時間（$7.30/月）
- **推奨**: `use_static_ip = false`（ベンチマークには不要）

### 全体コスト（8時間、4ノード）

| 設定 | コスト | 円換算 (¥150/$) |
|------|--------|----------------|
| **最安（e2 + preemptible）** | **$6.80** | **¥1,020** ⭐推奨 |
| n1 + preemptible | $6.80 | ¥1,020 |
| e2 + オンデマンド | $8.30 | ¥1,245 |
| n1 + オンデマンド | $9.20 | ¥1,380 |
| n2 + オンデマンド | $9.30 | ¥1,395 |

### 最終推奨設定

**プロジェクト: research-383706**

```hcl
project_id = "research-383706"
node_count = 4
machine_type = "e2-standard-2"
use_preemptible = true
use_static_ip = false
disk_size_gb = 30
disk_type = "pd-standard"
```

**8時間ベンチマーク: 約 ¥1,000**

安心してベンチマークを実行できます！
